<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写-Promise | 前端知识体系构建</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="楚岚博客">
    
    <link rel="preload" href="/vuepress-start/assets/css/0.styles.fcc2c73b.css" as="style"><link rel="preload" href="/vuepress-start/assets/js/app.8ee9e0f6.js" as="script"><link rel="preload" href="/vuepress-start/assets/js/2.cfb989c2.js" as="script"><link rel="preload" href="/vuepress-start/assets/js/4.f58268fa.js" as="script"><link rel="preload" href="/vuepress-start/assets/js/7.a1edbbdd.js" as="script"><link rel="prefetch" href="/vuepress-start/assets/js/10.289482bb.js"><link rel="prefetch" href="/vuepress-start/assets/js/11.bc011218.js"><link rel="prefetch" href="/vuepress-start/assets/js/12.06f8fb72.js"><link rel="prefetch" href="/vuepress-start/assets/js/13.0842d756.js"><link rel="prefetch" href="/vuepress-start/assets/js/14.a19ed644.js"><link rel="prefetch" href="/vuepress-start/assets/js/15.be134613.js"><link rel="prefetch" href="/vuepress-start/assets/js/16.4e02c0fc.js"><link rel="prefetch" href="/vuepress-start/assets/js/17.3bb3e4b0.js"><link rel="prefetch" href="/vuepress-start/assets/js/18.efff4d5a.js"><link rel="prefetch" href="/vuepress-start/assets/js/19.55de0958.js"><link rel="prefetch" href="/vuepress-start/assets/js/20.b06e8df4.js"><link rel="prefetch" href="/vuepress-start/assets/js/3.050ec1ac.js"><link rel="prefetch" href="/vuepress-start/assets/js/5.d621375d.js"><link rel="prefetch" href="/vuepress-start/assets/js/6.e73b1186.js"><link rel="prefetch" href="/vuepress-start/assets/js/8.ed420721.js"><link rel="prefetch" href="/vuepress-start/assets/js/9.511062bc.js">
    <link rel="stylesheet" href="/vuepress-start/assets/css/0.styles.fcc2c73b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-start/" class="home-link router-link-active"><!----> <span class="site-name">前端知识体系构建</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-start/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-start/guide/" class="nav-link">
  文档搭建
</a></div><div class="nav-item"><a href="/vuepress-start/js/base/inherit/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/vuepress-start/interview/html/1/" class="nav-link">
  前端面试
</a></div><div class="nav-item"><a href="/vuepress-start/engineering/module/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/vuepress-start/hand-wirte-code/promise/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  手写代码
</a></div><div class="nav-item"><a href="/vuepress-start/Git/rebase/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/vuepress-start/react-ssr/native-ssr/" class="nav-link">
  React-SSR
</a></div><div class="nav-item"><a href="https://github.com/Chulan-824" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-start/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-start/guide/" class="nav-link">
  文档搭建
</a></div><div class="nav-item"><a href="/vuepress-start/js/base/inherit/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/vuepress-start/interview/html/1/" class="nav-link">
  前端面试
</a></div><div class="nav-item"><a href="/vuepress-start/engineering/module/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/vuepress-start/hand-wirte-code/promise/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  手写代码
</a></div><div class="nav-item"><a href="/vuepress-start/Git/rebase/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/vuepress-start/react-ssr/native-ssr/" class="nav-link">
  React-SSR
</a></div><div class="nav-item"><a href="https://github.com/Chulan-824" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>手写代码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-start/hand-wirte-code/promise/" aria-current="page" class="active sidebar-link">手写-Promise</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="手写-promise"><a href="#手写-promise" class="header-anchor">#</a> 手写-Promise</h1> <p>先来几段Promsie的基本用例，先对Promise有一个快速的了解。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello Promise'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1:'</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2:'</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span>

<span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p3:'</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span>

<span class="token keyword">const</span> p4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token string">'报错'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p4:'</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span>
</code></pre></div><p><img src="/vuepress-start/assets/img/1.b451c83c.png" alt=""></p> <p>这里可以得出4个知识点。</p> <ul><li>1.Promise初始状态为 pending</li> <li>2.Promise执行 <code>resolve()</code> ，Promise状态变为 <code>fulfilled</code> ，即<strong>已完成状态</strong></li> <li>3.Promise执行 <code>reject()</code> ，Promise状态变为 <code>rejected</code> ，即<strong>被拒绝状态</strong></li> <li>4.Promise中有 throw 的话，就相当于执行了 <code>reject()</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello Promise'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1 then方法执行了'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABLAAAABlCAIAAADS/40XAAAgAElEQVR4Ae3dD2xc1Z3o8dMXpEHZt65omejG6yiATXdNXlnN4ETYSh8Ow4aEDSYtJKlYTNPEdmJjtQVkYiy/NfNqmQQ/aHeVxoljqMEp7yUQmhiLmDyM3X2RbSXDzNu2SfaRcQnybBgx3a0yqyJmtVHeuX/nzj97xvG/ON9RxNy599xzz/mMkfzzOed3vnL16lXBCwEEEEAAAQQQQAABBBBA4MYT+E83XpfpMQIIIIAAAggggAACCCCAgCpAQMjPAQIIIIAAAggggAACCCBwgwoQEN6gXzzdRgABBBBAAAEEEEAAAQQICPkZQAABBBBAAAEEEEAAAQRuUAECwhv0i6fbCCCAAAIIIIAAAggggAABIT8DCCCAAAIIIIAAAggggMANKkBAeIN+8XQbAQQQQAABBBBAAAEEECAg5GcAAQQQQAABBBBAAAEEELhBBQgIb9Avnm4jgAACCCCAAAIIIIAAAtddQBhou+PO281/bb7kbzDydrV19fZtb0WSr1/nn327td7t9l/n/aD5CCCAAAIIIIAAAgtKwN+5tap2a1Xn+Wvr1fn901BJVk0In2itqm3tC2dVOPdCWkdkX7R/+wO5VzB7d9w0e4/SniQDtlXPid3DB7co8Sf7d9/5aOf2o79rdMfPZTpyNf3uQpO8KEOjza+mFnI+dvCTx+TpyOFtZY2pl6/lTPitbWVNg/YayttOv7bJaT/DMQIIIIAAAggggAACCCwMARnl7gt46joqs4hSknpcvLOjWz0V6KnqHEi6lsXHSJ+34ZgVrLp2ddUUp96lNc84rVS0t66fWmAy2wFhakeurzNrXhp+7TGdWo5Vbl51x8mk4HZmu1PS+MnvpjnOndkGUzsCCCCAAAIIIIDAjSDgrunuuhH6ORt9VKPB0VXtXXqAp4aUe6o6E2PC8ECztyesVLZ2eGzDbFNr3HU3ZXRq3ZyJu1xNw21rxFBj97weAp6JnlMnAggggAACCCCAAAIIzJCAc0NLd3y4z1VZ55IjjUdts1vP7/f2iIr2rpZrjwZlF+bnCKE6+HbQBK4+cqGpxPwwDe8JldtG/HKvWikqEmLw42BEuNRBQ3UW65gcMLz/lJwWO6RXl9h4bSKrcUWImiOfNMpvV77U8+8/NLxHNKk3qjNRiw5qAlbztKm25p3pp6omVG7dqNWvPUOdrDtxDVZZDhBAAAEEEEAAAQQQyEogYXJjysRFuZRuT0jOZlT6rZmTJTXdO/XfgY361TIpmUGsZ2esXy4CbO4NCvt0Sn3cTBRtbGnekPXAWXzipRxw00OshHmeA/tqrTmfRs3qo0+Xtu4Qe+Uwnfa4/F45uVQIqwar+RMe6I9OAUm+J39ZkbAPQQV8PuGpm+IE0eTKhZh/I4RyqZ6MhWSw9LsL6r8j2w9uvnPb29OUHUZNyrI5+NKwVfngc2W377b7phLldGaosezOVe+tPa01/miNOLi5+rA++1ftV1njN8x+ydHFzs32tDeyJauCdZ/I80Mnd23bLI5cOP1S+eBzr+r5Y9S1kWqdw7vL07ZHRrlyzWSb/lxZsj7YZDxXKy5XaWpLNzVSWYmMPO8gM01aSU4igAACCCCAAAII5CCgDmd1dXR3tVRmCsHCvQ1VnaJOlunobq0o8nXaUrnI0Kt2j5DTTbWrXR27EseBZKzYcEzIiZHGI4RalZG3RlnfLGsTgT3NJ/RQIdJ3wAjPso8GRw9sfWdZu/b0XSXhnma9clel3h51aE6GXkbbZBtscaYs7L30nY72jUpw9EDrPrFLFQj3HMshsjh/WivsOzNJJp5L40H7F+I/MyCU/Hz7qWs6npOAUI2a4rlA75AZZeJ98Hc3DcoRMGPoTIiSRhlWDb43NB0RYeTwvlfluJy5CFCtXAZdonOfPXaKN2XSo3BQfjdrHipPWL4pQ1kz04z7ge1CDI2F1IqS+6Vseu3IdjHUdDD+55Dy3Vv1P5YMDX7jiDkoOnbBWk06QXtSWuJutKXtCb+1t1NUH7HOOLe0ycmur/bHHz1B1VxCAAEEEEAAAQQQQOCaBOJ5WRRXqSKCowH9d/vz+2XCFdeuxAHD+JPCJ46qQ2HWxEjFU69GgD4r4b6yfsdGRYR7D8jplOETB2QWlpIaW8wWrynTUVCssnKxFK+Sv4rbKs90j3VeqVinJ5sJh5fXmUlfQuHswxbtiTIkWZkmYYz1FBEeeEfGjUppiRFwRy59JsTSfKFmSTWymFZ5B7IJGeJ1JhzNSUBYvntYH6oy/itDPvMV6O9MDrGWFZWLoZMfXkMnjcrDQ+8PieoHEkaonavXynWAesxmtiHL90CbTDpa3rbHyDFj3JVQv5oDRp/vmqZfouTBaiGCF82fmfK195t/VllTVJBlI4xi+uTV58rSDqVGTp0cFNvX2f/copU/+EEOf8DIrT2URgABBBBAAAEEEEDAEHCVpM/SGb4kB04yh0MR32k5IzThXkVZLsSAPrCmVS7HJ+WgYvCYd6ucPionrGaKLTN8F0X3aiu/Mlyd+LTt3qmO16mZeDqSJtAmPVRdLijjoJKKxOWCgT17xY74sKocrqztseLkpCom+zjP1hBqI13qNM7nkhpenvR5Kh9DY3LTCLnqL/WlRmUlCeN8qWX0M/a2yXV6nyRGg5nuElq/0l4dDMr/D3IM/9JUJHfjGC6UO22YdPY1hOPBITlQ+egdaXbpSFMTpxBAAAEEEEAAAQQQmA2Bzy7JUCfzL8K/D8nL4T1VtRO3pXhnjUddoKhU1k/bsrqJnzhrV+X6SXV1ZZpA17UrnnVGGAKnA5XuhKGvLNs5zwJCbeRKxLd2yLIX2RUrKFyTWlCLEqtvyyoalHfbA63UyjKe0fol55cmvPR5nrkOBiZUYf/g3PLahS3qCS27jIwMg0bSGnWIVRRmt82jvUKOEUAAAQQQQAABBBCYM4FbCxThW5q43UKaxmjzTpUiuX6vuTM/7X59aW66Dk4Z2XRS8vQ485cKocbSxebsQnUGqTzWZqtmG9XYAOZkyqjt+cmHBYXl07ViMLlqkW6eZOTimEiaTply33ScSNcvNRYtf3D1FL61iVskI0Mt94ya/lR9OW8rFKwYnNiMqwgggAACCCCAAAKzLRAPY4wna4sGrVZokc8ki/r0MTS5zrBZW15oJZixKtG2hlfX2k15RqWtquk+lFlG5TrA/emWcfk7tY3pE0YCjcerSUfDly7ZG6PGh7YprPZLkx/Pt4DQuaVOTbWyajozf1oKruqXZAqZzfGFdr7dcieGNS9tTz+r2bpvGg5S+iWTjm6WGW7qtsQj+2t4jMyeahfTVkvGs92UbJe5SeP5Tq/hOdyKAAIIIIAAAggggMA0CSie77hkSph+ffGbtpfDcjN1ivoId4XMXDqwL3PGFD1qKqmplL/N2xPM2Nun5uRUX/aVh/brEx27V3rkje8YWUwnKjmlaxmzjBo7Ydh31LA9QFn/aIlkMbOtCqHn5nk0+9yqtsrk4TybMipbpCZieVDuQ3i7LfVofMs+da+/+Fo4uSOFtl2hzFKjp9BM2ItPqJsrNKn9NXf8UzdvuE3WYK1RVNPbTE9Ipj5mwpfsl7rKL94vuUXha/ZELxPdPUm/1HSpF6tvv2PIqiNx/0N1Nun9ch/CsjsbrRLCQouf4ggBBBBAAAEEEEAAgVwEjK3/zFvkthC96vGke+vpN7hr2jd6G4yN/mT803Jrn3cgnglf8bR23N3nbZAZU8wHxPf6s6ImM5GMc8OOylFvzzFvq7DtQ6gGdQEZE3rUJKK5vuT+EzWiqtPolExHku0Ohwk7GQqfHAlUH510u5pl1BdISaujpxWVxQOJ6yfjmxwW7+zYJTdvtFZXymmlXVNfP/mVq1ev5gpDeQQQQAABBBBAAAEEEEAAgQUgMP9GCBcAKl1AAAEEEEAAAQQQQGChCxx68/AHHw4t9F5eT/17/Lub1j5wf64tZoQwVzHKI4AAAggggAACCCCAAAILRGC+JZVZIKx0AwEEEEAAAQQQQAABBBCY/wIEhPP/O6KFCCCAAAIIIIAAAggggMCMCBAQzggrlSKAAAIIIIAAAggggAAC81+AgHD+f0e0EAEEEEAAAQQQQAABBBCYEQECwhlhpVIEEEAAAQQQQAABBBBAYP4LEBDO/++IFiKAAAIIIIAAAggggAACMyJw0+XLl2ekYipFAAEEEEAAAQQQQAABBBCY3wLsQzi/vx9ahwACCCCAAAIIIIAAAgjMmABTRmeMlooRQAABBBBAAAEEEEAAgfktQEA4v78fWocAAggggAACCCCAAAIIzJgAAeGM0VIxAggggAACCCCAAAIIIDC/BQgI5/f3Q+sQQAABBBBAAAEEEEAAgRkTICCcMVoqRgABBBBAAAEEEEAAAQTmt8CCCQgjx/+b9/C56PzWpnUIIIAAAggggAACCCCAwDwSmD8BYeT4D6tbfhGIitjZ997yh3M2+vKfDwU+c+R8GzcggAACCCCAAAIIIIAAAjeqwPwJCJ3Llg4FFznzhGNFeVF/5T21vwxN/qVcsRcpKFhKQGgH4RgBBBBAAAEEEEAAAQQQmEjgpokuzu41x1cLhi9GhCgQi13Ptmx6PBCJRRzRrzmdi7R2xCJnzwQv25sUC3T9sLeo+3hTiR4HFjm/Zr/MMQIIIIAAAggggAACCMyKgL9z676AEK5dXTXF1/DA8/tr9/iutZKsnh8+0drcKza2NG9QsiqfYyGtI+Y9JTXdO13mh3n3PjcBYeSXz+wKraly3Wr3iPxLngj7h099qZ2879m7/D9at3m49JW+v3t4mYwJHc4id55jsYz9Ioe3NYm2g1uU0rLf1tlriB/LkUM9jIyf4ggBBBBAAAEEEEAAAQQQyFpAi3I9dR2V7qxvMQsW7+zoVo8DPVWdA+bJbN+N6NoqnjlCNktOrZH6A+YmIBRX/m3wjwWvrU4MlG8u/dHxwntWl5rzPkvLPtpuMcgDLRq0nxAiPmz4+7F/+VycGRm+RS0wPuDtEi1HW0rzEovzCQEEEEAAAQQQQAABBKZfwF3T3TX9td6gNSZghgeavXuqOtMNvQZ61FHZa33NnzWEQizOW/bPEStPaCwUiiQsEUzXVYdzRWlp2Wr5797Cry8pXKkfl95zm2PJny8jGkxHxjkEEEAAAQQQQAABBBC4XgQUz3fkKFrA509u8Pn9cuzRtasucYwtudTkn+dohDCpYfoMT+eyoqGz40I41auxj15dt22sse/gE0XmiGHSTcZHY2poJBIsdGt3yvPRz84V3Wt+SH8bZxFAAAEEEEAAAQQQQOBaBSJ93oZj5g4BSkV763r7b+HqUrqQPKn0WzMnUxbUJSy3S2lOxvq1RYDBhFWL6mBaT1gU5bQy0Jx1KYRS2driUVcUJszzHNhXa835NGpWH326tHWH2Gs+Lr9XW0Jp1ZDSjbQn9EengKQrq+TnJ572d+7xCU+dXLHZmXgh509zFxCGrOWCMf/rTWcfOtLx7YIVi3svhIVbfg2xkfdfF1ve2DRJNGj198rl6C0FS2zrBh3/eeI40rqTAwQQQAABBBBAAAEEEJiigHNDS/cGea8WjKWtI9zbUCVDl45uuRJPDaU6W/usVC5a6CUjoi5jmCspONQ+yiirQ4vT1Ec0VI0bkyeV9c2tQiaG2dN8Qo9CI30Hco4GRw9sFavau2pkEKs+q7kzX02K46rs6qiUfdECtgzL88I9zV55qf2St2H0QGt46a6ulksyHD0W8GSdP+b8aW3Cp+/MeeHKnIlHmxdaUqMJWL7GSXVxY8rIoVUoy4O5mzJa4NamespJniucV5zuFQVCFK7wDI19orY8evKtNwrrNlvLCSftzcWx4bsLlk1ajAIIIIAAAggggAACCCAwuwLxmEpxlSoiOBqQWwvIlzHpMVMEFT5xVB0E00ftZHHFU19RZJ88qazfsVER4d4DfWEZah6QA5UlNTllDQ3KaNAc0ixelX5mptbSdP9RKtbJeEy+wuHl6kid9gqF9a7pnyb+r/ZEIUpWpokGZeRcVbtV/dc5IMddE4kmcZv4qSlX52yEsOw2azBZzvZcIvcfFCLvnm+Vt/3fc02lece6T677wYsrbCN+KS1POBH9f/4lf/mgOSYYufDxXQWbEgrwAQEEEEAAAQQQQAABBOZCwFWiB07Jzw5fCmUIh7SSEd9pOSP0Ufu9irJciIHTgUq3MaIoxyd3hWr3HPNuPSYDxuTAKfmBKZ+L7nVZMUnKxUlO6Pdq4V/KfM5JbjUvJySPMU/q73L8s2u9fiiHLhuqeuNBdXyyaOItU/00ZwGhw2GGbyIWDRnL/5wr73NWDg1/I9IWffroQxMmhfmPWPTTsY9+7Y/eUr5udd7ge6HyBvu3ucTxJ1Ml4T4EEEAAAQQQQAABBBCYcYHPLsm1h3KaYIbX70PycnhPVW2G68bp4p01HnWBolJZn7B8ceK7rqOrxTtbKuVk1HdOrHPLDoYH3gnIgdAp7ISRqctzExCOj4+7HzTjtyvqxoM364OByyuevLts2w/Flr0fmcOD0egf8vJu0dp/RYaOYx+def/98bPiUO+dT1Ssefgu9cKnh94QlT+Xfy4wXjERMw95RwABBBBAAAEEEEAAgetQ4NYCRfjk2jxzNmaGLmjzJ5UiRS7q01cAZih3HZ9W8mXYLEdT5SscGFHD5M6tVQn90TPfxEcREy5O8mFOAsLo5xdLVxTGopGY+JO8vNC54fLCaqOdDqfijH1RdJeVTCb8q8HPHn7kFhHz/eRbm/dF73r42aef+mn/03nx2aTR/lfeWlN33DaeGBkbKSw3481JALiMAAIIIIAAAggggAACcyCwNF/mktQW3Rm/uWuLBq2GOPOX6tstFNtnjVqXtQOZg1RLttlSmS/T1cQTzNhKGSlDpxYs2eqZgcNss4wGfD45t1ZRlWxTSY0GTZT5Jqs2z0VSmStjfkfpPQ5HniMy2L7u9nW7Y/caG0aMv13fdqXlaJtoeeSpw5+qHYj6x7+UPwlyV/qSujeP9P9j3yvVnkJbNCjG337++Ld+Vq+NFKrl5Ct2WQ4QGkOO+hn+iwACCCCAAAIIIIAAAvNLQNthL9zbr+fJ1PZyWF6ibvtgvNwVlYoY2OcdMHe1MC+Y7/5OdccLff6kPcGMeV1995/RN42QKw/tp7M6dq/0yCWL75zIPk9MVtWahWxZRs1Tad5lblVtv8HEvDJpCk711ByMEModJUTF01oSmcJHWnqWrY4UlRfK9o+//cyPxre92Vyat6j0zYuPPPrXjwReeLH8bEAYfxJwFJWoxeyvyNDulyNP/bS2QMRCwXDeEiUvT65M/M3oYc+Kens5jhFAAAEEEEAAAQQQQGD6BYyt/8yK5Q4TvepxVnvrCeGuad/obTA2+nPJnRtu7fMOyNEw46V4WjvulvscNtf2mKfiuwXqw2tyH0IzUnJu2FE5Kjd+8LYKa1sL+QgZ1AVkTOhRk4jm+pL7T9SIqk6jUyL7HQ4TdjIUPmOGZ9IGiWqWUZ9cEJicZTRp7w15V/cGW5ycaycmK/+Vq1evTlZmeq9Hjv9ktOzphxNmdF6J+l//yXBxXX2pdToW/MXzj7/4buSL0t3/8MaW1MWmV6Jnf/nq8J89UW3eEguNvNG+++V3z8nhQfePB4/+Teo909sRakMAAQQQQAABBBBAAAEErm+B2Q4IoyMng3+51r3YrjY2+IvP/8t3S52L7Ce14yvRYOBXwUX3rXPZVgjKK38IHD8l3Gtdy6xMpeat4//rqcbIEz+tS1ebWYZ3BBBAAAEEEEAAAQQQuEaBQ28e/uDDoWushNunUeDx725a+8D9uVY42wFhru2jPAIIIIAAAggggAACCCCAwAwJzEVSmRnqCtUigAACCCCAAAIIIIAAAgjkIkBAmIsWZRFAAAEEEEAAAQQQQACBBSRAQLiAvky6ggACCCCAAAIIIIAAAgjkIkBAmIsWZRFAAAEEEEAAAQQQQACBBSRAQLiAvky6ggACCCCAAAIIIIAAAgjkIkBAmIsWZRFAAAEEEEAAAQQQQACBBSRw0+XLlxdQd+gKAggggAACCCCAAAIIIIBAtgLsQ5itFOUQQAABBBBAAAEEEEAAgQUmwJTRBfaF0h0EEEAAAQQQQAABBBBAIFsBAsJspSiHAAIIIIAAAggggAACCCwwAQLCBfaF0h0EEEAAAQQQQAABBBBAIFsBAsJspSiHAAIIIIAAAggggAACCCwwAQLCBfaF0h0EEEAAAQQQQAABBBBAIFuB+RIQ+juq9w6MRa9k2261nK1w5F1v4y8CEduZXCqiLAIIIIAAAggggAACCCBwIwrcNJedlvHbIvP5l4f6x56u95gf07xHju9+9cuV9y1zGNfGB3b35L1w9GmXPHHhHw8Ni7Veq7Y0t3MKAQQQQAABBBBAAAEEEEAgQWAORwgDbauefHkgFDPbs+RrTvMw/fuXH4+JFaVlq41/dzrO3bNSjQaFGAuecVVVlpqhYvrbOYsAAggggAACCCCAAAIIIGAXmLuAMBQ8Gyt0lxakj+KuRMYj9nbajiMjb7wdGNfiSMfN2vmwf+jrm9Yvt5WRh0wfTfTgEwIIIIAAAggggAACMyXg79xaVbu1qvP8tT3g/P5pqCSrJoRPtFbVtvaFsyqceyGtI7Iv2r/9gdwrmL075mzKaPTXIxcq3A7/yLDW2bMh8fl/jA6fulX7FPO/Xv/yxYqOn7etK0ixuBIa6omWfdtlXYicOjm+vOLCqZEL5qnxAW/jqfKjxxvdi81TvCOAAAIIIIAAAggggAAC2QvIKHdfwFPXUenO/h6jZPHOjm71MNBT1TlgnJvCW3ig2dsjg1alor11fdJ0Shlz7vGlv5TTk+YqIIwOD4n//vwTZbcYrb35lBgpurdstdHNstW/rZ+gH1/P++oiETUKyKqGyh7bW7ZaG2uMnvzRhmD1P/R/MsHtXEIAAQQQQAABBBBAAIFpFHDXdHdNY3VUpQpE+g6o0WDKK9LnbTgW9tTVeHzXEm0a9c7RlNE//Mq/4ql1ZjSot6Xoz5KC3pSupz3xaW//ijb3v4WMi6Gg31W0LG1JTiKAAAIIIIAAAggggAAC14VA+MSBY+GijTWVSmJz/Z0No6vau6YybplYkfFpbkYIz444Kp8otDUocuFjh+NB2wntcNwXuNnlcqbmDv3Tr5orD2P+96PV33vi81+ORkVhnhDRi8E894PygBcCCCCAAAIIIIAAAgjMtIA+WmU8JWVmozqtMSSnOyr91szJkprunfHFX/JGY+pjhoZmrF8uAmzuDQrXrq6aYuNeY4Jl0caW5g1JUVSG2uVpbV6odlmpbG3xqPclzPMc2Fdrzfk0alYffbq0dYfYq87nVE/m98rJpXL6pllD5sfZr+iPTgHRioQH9vYGpeeGpb8etd8jhByMzX0Ka2IVCZ9mPyCMjftGPl/8p5dHRsbjLRkbOV24JDQy/Mf4qdhvXqttH1r2vYNvNpcnxIT/GgkuLTJCvuCvLri3b1nsOBv1fxRbu8Yhgr8+WXbfK/FaOEIAAQQQQAABBBBAAIEZE3BuaOneIGvXgrG0Twn3NlQJuRJPDWPUUKqztc8K2LTQS0ZEXUaImBQcah9llNWhxWnqIxqqxo0IUFnf3CpkTLin+YS+vk6fYJlbNDh6YKuQo201cqai+qzmznw1vHRVyvE32ZeJ1hCGe5q9slPtl7wNowdaw0t3dbVckuv9jgU8ieFuWhL95PnTWrIZ35nzwmXGtEZxrS+y43LdYLo5oxNUmvul2Q8IHcu+WbrkJofDPu4XDnV9ETr79x0FXW88aSULXV36T7XpOvRFVFgDhAVrt5SoZYqKY8d/I9aUnBt+b627Lt1dnEMAAQQQQAABBBBAAIG5EIjnZVFcpUpvz2ggskFNkXJ+v1wC59qVKYIKnzjqk5GkPmon26146itGmnt9flGsD5Ep63dsPN1wrPdAn6u5JCAnWIqSmhzGBoUIymjQTNZSvMolfIF45ZNCKRXrZDMuySg3vLyupViE5aEIheVWCVkuhNOfKEpWJkWDMmzWJotaHZ+0KddUYC7WEDoSo0E5z/PM0OA3n+7oedj/PwPWtoSZuhW5OFak6MiFziVGKcdf3BX8ICDODR1xrStjwmgmO84jgAACCCCAAAIIIDDbAq6S9FMcw5dkGpDUcMhsXsR3Ws4ITbhXUeTg0YA+sKYVk+OTu0pE8Jh3q5w+KidYZootzTqT3ovudWUZvCXdKD/a7lXy81OvZ3FGzcTTkTSBVh1r1SaL7sh+1msWj5qgyOyPEKY2Jjr4/kn35ueLlLw1oarDY0eetK8utBdf7FyyWFz4p5EVpbHxqFjxg+PxXSWU8gc/fqHx0Dn3g8eJB+1mHCOAAAIIIIAAAgggMC8FPrskp0OmbjJntvX3IXk5vKcq7aRBs5AQxTtrPOoCRaWyPnljhnih6+jI39sT1ieLzlKj50FAeO7Q3qGHn/2x+rPwSF35Xz13qOzIE0X2CaUGhXPL37WJRef2ntzkbnBG9lX33N3W5LFCeuf6b4vG9k19PyYenKUfHR6DAAIIIIAAAggggMDMCdxaoAifXJtn5YxJ/yht3qlSpMhFffoKwPTFrpez+sLCnubanoQWy3WYvWl3I0woNaUPcx0QXgkd/h8/yWvoN7aguGu717WutrUgOZGM3jcZJf5m6LhnbbWcdPqDxt9uXrPtD/2vPab/VSEWPBty/PHff/uZWJH5zwxTIuImBBBAAAEEEEAAAQQQmHaBpfkypad90Z22aNB6jDN/qUz4OfGiPpmDVG7OLtcZVuarSUetBDNWJVbK0Pg6Rtu1OT5Ml2XU3NHeapqerSfNxvRWiWs8mIs1hPEmx/ztVS2L2n4a34LCUfbMK2tOVT/+/LvjV+LlzKNof8/Z+h2l6p4TiwqffKEu+GKvX7s2/nb934oX/s+Bwq7ve09ypaYAAANCSURBVAflQk5eCCCAAAIIIIAAAgggMK8FFM93XCLc26//Qq/t5bC8xLZdhLtCbsE3sM87kCnRptyRT0skUynXKKoJZhRZ24G+xNL+M/qmEfaVh9mquFd65JLFd07MUHhhyzKabYtmotzcjRBeiQ7/fdXL0Wf+9/61y+wTRBe7mn7+s+j3n/qvq/qbDrxQXWJNChXR9/b5H3qxyfoh+WbF7peFW8SCrz+z61+3vdngylvkem1H9V+te6qp58Un72Lu6Ez8wFAnAggggAACCCCAAAKWgLH1n/lZm9koP6TfW88sZb27a9o3ehuMjf7kjoItt/Z5B3zWZcXT2nF3n7chYf6kudefsX9gPEmpc8OOylG58YO3VVjbWshd+2RQF5AxoUcmEc35JfefqBFVnep0Te2V9Z4WCTsZCl/n1ir1/qTbM2YZ1R+W8b+Jlau7emjNy9I8pdqvXL16NeXkzJ8Ij+z1HhJ/80L96ni8l/DUyFDb9+sPnos5Ctc++9KL1a48EXp3b8BV/3DifNAvxg6/+LPIQ8/Xl1r1xM52VD7aHnB4tne0NJYlFk94BB8QQAABBBBAAAEEEEAAgRtbYNYDwlho8N2R6G2l61wFCVsRpn4NVyKD+3od39uubSMRHf9ULFtuH/SLRXwnP/ys4P6HXAnb1mv1RHyBL12uhIHH1Po5gwACCCCAAAIIIIAAAlMVOPTm4Q8+HJrq3dw3/QKPf3fT2gfuz7XeWQ8Ic20g5RFAAAEEEEAAAQQQQAABBGZGYG6TysxMn6gVAQQQQAABBBBAAAEEEEAgCwECwiyQKIIAAggggAACCCCAAAIILEQBAsKF+K3SJwQQQAABBBBAAAEEEEAgCwECwiyQKIIAAggggAACCCCAAAIILEQBAsKF+K3SJwQQQAABBBBAAAEEEEAgC4GbLl++nEUxiiCAAAIIIIAAAggggAACCCw0AbadWGjfKP1BAAEEEEAAAQQQQAABBLIUYMpollAUQwABBBBAAAEEEEAAAQQWmgAB4UL7RukPAggggAACCCCAAAIIIJClAAFhllAUQwABBBBAAAEEEEAAAQQWmgAB4UL7RukPAggggAACCCCAAAIIIJClwP8HYHInkdlBsvIAAAAASUVORK5CYII=" alt=""></p> <p>这里可以得出3个知识点。</p> <ul><li>1.Promise里没有执行 <code>resolve()</code>、<code>reject()</code>以及 <code>throw</code> 的话，这个 Promise 的状态也是 <code>pending</code></li> <li>2.基于上一条，pending 状态下 Promise 不会执行 <code>then()</code> 方法</li> <li>3.Promise执行 <code>resolve()</code> 方法后，<code>resolve()</code> 方法传递的值会被 <code>then()</code> 方法的第一个参数（函数）接收</li> <li>4.Promise执行 <code>reject()</code> 方法后，<code>reject()</code> 方法传递的值会被 <code>then()</code> 方法的第二个参数（函数）接收</li></ul> <p>最后需要注意。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
</code></pre></div><p><img src="/vuepress-start/assets/img/3.4af0ab7a.png" alt=""></p> <ul><li>规定必须给 Promise 对象传入一个执行函数，否则将会报错</li></ul> <h2 id="promise-初见雏形"><a href="#promise-初见雏形" class="header-anchor">#</a> Promise-初见雏形</h2> <p>根据上面几个案例的总结我们可以得出一个基本框架</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 初始化state为等待态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
    <span class="token comment">// 成功的值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// 失败的原因</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// state改变,resolve调用就会失败</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// resolve调用后，state转化为成功态</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
        <span class="token comment">// 储存成功的值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// state改变,reject调用就会失败</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// reject调用后，state转化为失败态</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
        <span class="token comment">// 储存失败的原因</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 状态为fulfilled，执行onFulfilled，传入成功的值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 状态为rejected，执行onRejected，传入失败的原因</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promise-异步实现完善"><a href="#promise-异步实现完善" class="header-anchor">#</a> Promise-异步实现完善</h2> <p>先看一段示例代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>正常来讲，上述代码会在 2s 后输出成功，但是现在代码并没有输出任何信息，这是为什么呢？</p> <p>原因很简单，因为我们之前代码实现的逻辑全是同步的。但是上述代码实例化一个 Promise 的构造函数式，会在 <code>setTimeout</code> 逻辑中调用 <code>resolve()</code> ，也就是 2s 后才会改变状态，结合我们实现的 <code>then()</code> 方法，onFulfilled是同步执行的，它执行的时候 this.state 仍然为 <code>pending</code>,并没有做到 2s 后再执行 onFulfilled</p> <p>那么改怎么办呢？我们似乎应该在合适的时间去调用 onFulfilled 方法，这个合适的时间是开发者调用 <code>resolve()</code> 的时刻，那么我们现在状态（ state ）为 pending 时把开发者传过来的 onFulfilled 方法存起来，再在 resolve 方法中执行即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// 存放成功函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledFunc <span class="token operator">=</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    <span class="token comment">// 存放失败函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedFunc <span class="token operator">=</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token comment">// 一旦resolve执行，调用存放成功的函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onFulfilledFunc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token comment">// 一旦reject执行，调用存放失败的函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRejectedFunc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 当状态state为pending时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledFunc <span class="token operator">=</span> onFulfilled
      <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedFunc <span class="token operator">=</span> onRejected
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过测试刚刚的代码发现，我们实现的代码可以支持异步执行了！不过又有一个新的问题，再来看一个例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt=""></p> <p>正常情况，这里会按顺序输出1，在输出 data</p> <p>而我们实现的代码却没有考虑这种情况，实际先输出了 data ，在输出1。因此，需要将 resolve 和 reject 的执行放到<code>任务队列</code>中。这里姑且先放到 setTimeout 中，保证异步执行（这样的做做法并不严谨，为了保证 Promise 属于 microtasks ，很多 Promise 的实现库用了 MutationObserver 来模仿 nextTick）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onFulfilledFunc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRejectedFunc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这样一来，再执行 executor(resolve, reject) 时，也能保证在 nextTick 中才去执行 Promise 被决议后的任务，不会阻塞同步任务。</p> <h2 id="promise-细节完善"><a href="#promise-细节完善" class="header-anchor">#</a> Promise-细节完善</h2> <h3 id="多次调用then"><a href="#多次调用then" class="header-anchor">#</a> 多次调用then</h3> <p>到此为止，我们的 Promise 实现似乎越来越靠谱了，但是还有些细节需要完善。</p> <p>比如，在 Promise 实例状态变更之前添加多个 then 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一次调用then'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二次调用then'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以上代码会得到以下输出。</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAtcAAAA0CAIAAADOo4MPAAALk0lEQVR4Ae2dX2hb1xnAT9YWusHISwVqSWic2Bt5Kcg4ZjGDKfNIl86EECfuk0ka24rttz04MalZZuLGbsJgsGK7ShpM/dI6SwhuSdpQLx4MNziKTbeRsPxpOxxsET+FwTbYhnbOPdLV0b3StWRJ17HyE8E65zvf+b7v/K7Q+Th/lA2zt7/64Q+2CV4QgAAEIAABCEDAXwLf8dcd3iAAAQhAAAIQgECSwPPy/W/3HsIDAhCAAAQgAAEI+ExAZSE7al/z2SvuIAABCEAAAhCAADsyfAYgAAEIQAACEFgbAmQha8MdrxCAAAQgAAEIkIXwGYAABCAAAQhAYG0IkIWsDXe8QgACEIAABCBAFsJnAAIQgAAEIACBtSHgUxZStbXGMT63xKGw6uqKlldUWLVrOkIAAhCAAAQgkD8BdVPXn5c993/z9X3t0ZbIqi1cRTDSTkHdpbLdxYzBdO0wmEvN7uLQt+UUIAABCEAAAhDIRcCPLERP+fbEL0Oxy3bBjE8Kzaq77JjyzazCrbyiRFszI8kagOnUVJb2s+qv6BcFCEAAAhCAwDNOoOxZiD1h27mCLZHobaH5GMz53pTnX3anBQ6bjmr+lletufz7jvqru2cvHAys2kRhHedPb20RE/dP1BXWDW0IQAACEHASmIseHp5v7B5prXW2eNeXP+3vuVl/dmBPmb757452vRsLHT8f2e4dh3dr/NpA3+QDS8cYY3yqr388bkmDe8s3hLJnIeZ8r8umRI7PUfVmlavVNmKmOLaymZTYZbuLVNNC/deU2xYKKviecBQUnVN5bqimWUx80xtyNlCHAAQgAIFKJ6DypCuidWCkL5gx1Luj/eObImMDcmpQ6UjPaHCssyzTRNmzEDkse+LPGGKqUvysn7KU/V16N13osiMkKXSouW05ujiqbn0kEIAABCBQIQRqI2Pnn8ahbO8cGSsqrvnPVApysjEzBRHxa5diwVaVgshXsHF/aHx4cioecqoV5TrZ2Y8sxEwCpFtzvi/tXO6wrP06vLuh2THYBbeOlJh2TEd6RLqLWgU5Nm2Vp+u3nrAK4aGZc2+mHvCCrRAxlh/iF480nLhhae86M3PhgF66k1sqw9tmuh82tJxTTRl2LN1sf2JDVS0f2A0ddslwIcKn9caQWgWJao2WqmSh7dLXvXrF0WgVHezs2CQpQAACzxSB7LsVQsg9msubz+5f6BmeVzwy9iyMvQzVlOZlbaDoqr2NopUzq8J7B2R+vD06lbZq91Uiw4Wo3neyrynt3lr2iBt7LnIUt6aC9WfTKkmjy7HZB8H6o0l5fOqyGuPiYsZYkqrFv83e/ipR5teWqmqPfyVxLu077LglpoLdaheyttpCh5p39fHF9i1vTTy2O1sFJZQcBudUbWnirarqd25ZDWY5MfdOVfVbF3VXVd5S1f7RklK7PVjttmn1N/7cGrT1E5appIvE448G7XhMFynLOirDUuLWYKpvwop88LbZShkCEIDAs0Vg7sO2zg/N78Hb7x9q6zz09lXr+1q1nvrE+rJOLH3xduehEeurPpF4/MmvUzqJOyO2viVve/9OkmG6i6mTF2AVhm0nw527uwomcxRKMjKnnMqxpIdj2dFDWLp6SnVREaYG6DZclMSPtRCZKnksJBSfSBVvwVwFMUM1LZs6Uu6ompo5y3IRQh+/CIZfD4vPv10WdYHlP12/EZm4kDxDGuo4E66/Or18IHmItWMiuY5S+7M2EX24IITHEae5Lz6QSyn2uosRRuDN3oOpaujnEdH84JGnJSHqevVKjuwV+PHuXeL6/biodeXLKZu8QwACEHgGCYSOJ4+dhurqxNSjJbVWEJ//Mi7l7iMU8zG1x5E8phpo2tt4JRqbE9vV4nOwcSCy2B4dHw1NqaOmxR1ljc/+Ob4n69ZJoOnkWJPrMcWise6RsU4pd57/sNZOXj5+fmS7bLosXn2lLHOAT1mIY852VHNN/C5a2QXSmsOClrjljv5mGNqCKXEomy4clj16OYy4qwsPpkV0OrUhYrWHd7vV8pAs378nRHV2RWOryFKIZFczpOqKjbUTpGXh1402ihCAAAQgkJ3A4oK+bOJsjcf/rqb5rnGjoTFdDrV2h/Q1nGJuu8g846zo70l6ydipSbtylOoiqYs/+vzHrbsi9JLUiUV7hDwNo9OppUV9WcbRtxRVP7IQe/7Wk3cJp/BiCNjBFGOk+L6bq8Mi0l3eKyqxofpjYmjmvl4msS7FeAe+/PGRlnP2yRV1puS6dwdaIQABCEDAi0Aw+KoI7nSfA9V95OmT4aXW7r1fDvdP5dLxsp5usxc81AGRvmveN2wDr7wsbsaXzbXx4GaZggTq6quvzO7cl1rRUSlUqLnAW8rpmDxL/v2CuyP58IyqgEa3WVsisx9ZzmXLzo20gtTMpWwbzGXKIQ9s2Samr/8hv8xR7XdEW07HHDZWUQ389I3wDbmbo7pmrGQsf/tQiG01ei0tNpQ6kZp0odKg6OdzGQ4fPZwWu6o3WbLlj08kT85mqFCBAAQgAAE3gdodjWJebrXIlz4NmlKRuzbx8feuWV/RKVnyfX68b1LsO9pYu+foPjHeF71rtEsjh9u7Do9aZ2AN+YrFlzY5N1C0qXHz615GG5/8LClRp1CrfxRS+/7B0M6gHW186r3JB3U7ilmk8Yi27Gshemp3TPk6oKxNuVIBxxiyGpQ6joxBJyJuZYfEUXX4Krha13spUtPcUNOreq50tyV48MKMONJQU5VyY1yTSYnyew8cOD10tUHfzemYmBkabpDZh3xpefNW6+5M+PSlM+FmY8Uwo1XoOzKhExNtVS0NVcdU946JiY7pYVXiBQEIQOAZI5CRSQx3yZspjosnLh56b0Vpqosz3Qs9l5Mq8lbt8dGunvbJVBe9Y2JdeJGa1mWWQNPR1pv977ZHV/dDZOYFGSHyOWISah3YO9DXddiKyRiaPKpyUsifCdHR1kXK9GMh0u0GeUdmR+1rKSh+vDsShRK6zGU5f7nU1PHYeUmuvlrNrV/C4WAKAhCAAAQg4EVA/airWF3K4mXWx7Y1yEJ8HB2uIAABCEAAAqsk8Jvf/u4vf72zys7l6TZ2fkT+pNjU4p5GdUrD+q0R+QunnSG5a1MehxlWlfdSv8hCSk0UexCAAAQgAIFyEkjvvJRzr6ScI0jbJgtJs6AEAQhAAAIQgICfBHy6I+PnkPAFAQhAAAIQgMC6IEAWsi4eE0FCAAIQgAAEKpCAuqn75MmTChwZQ4IABCAAAQhA4OkmoLKQjRs3Pt1BEh0EIAABCEAAAhVIgB2ZCnyoDAkCEIAABCCwLgiQhayLx0SQEIAABCAAgQokQBZSgQ+VIUEAAhCAAATWBQGykHXxmAgSAhCAAAQgUIEEyEIq8KEyJAhAAAIQgMC6IEAWsi4eE0FCAAIQgAAEKpBAAVnIp/P/qUAADAkCEIAABCAAgTUikG8WIlOQU5f/Jf+tUZy4hQAEIAABCECg0gjkm4X8ZPvzNcHndC7yj38nKg0D44EABCAAAQhAwHcC+WYh339xw0jb93Qi0n3hnyQivj8pHEIAAhCAAAQqjUC+WYgct05Earc8d2/pfyQilfZBYDwQgAAEIAAB3wkUkIUkY9uwQRYS7Mn4/qhwCAEIQAACEKgwAup/s8vzJXdh5BKIXAiR+zJyd0YujeTZETUIQAACEIAABCDgJpBvFmKnIL8IvfDLN14kBXGjRAIBCEAAAhCAQEEE8s1C/nj3v3IVRKYgv9r/3YIcoAwBCEAAAhCAAASyEsg3C2kKvSD7679ZDSGEAAQgAAEIQAACBREo4HQqKUhBZFGGAAQgAAEIQMCbQAFZiLchWiEAAQhAAAIQgEBBBMhCCsKFMgQgAAEIQAACJSNAFlIylBiCAAQgAAEIQKAgAmQhBeFCGQIQgAAEIACBkhEgCykZSgxBAAIQgAAEIFAQgf8D58hYeY6wCdkAAAAASUVORK5CYII=" alt=""></p> <p>而我们应该得到 <code>第一次调用then data</code> <code>第二次调用then data</code>，这是因为第二个 then 方法中的 onFulfilledFunc 会覆盖第一个 then 中的 onFulfilledFunc。</p> <p>这个问题也好解决，只需要将所有 then 方法中的 onFulfilledFunc 存储到一个数组 onFulfilledArray 中，在当 Promise 被决议时依次执行 onFulfilledArray 数组内的方法即可。对于 onRejectFunc 同理，改动后的代码如下:。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// 存放成功函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 存放失败函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 当状态state为pending时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="onfulfilled-为-promise-的判断"><a href="#onfulfilled-为-promise-的判断" class="header-anchor">#</a> onFulfilled 为 Promise 的判断</h3> <p>如果 resolve 的内容还是一个 Promise 的话需要得到该 Promise 决议的结果再次传给 resolve。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="promise-穿透"><a href="#promise-穿透" class="header-anchor">#</a> Promise 穿透</h3> <p>根据 <a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promise/A+ 规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>规定，then 方法里面的两个参数如果不是函数的话就要被忽略。</p> <p>所以then方法的 onFulfilled 和 onRejected 参数需要加入函数校验。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
  onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 当状态state为pending时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="构造函数出错"><a href="#构造函数出错" class="header-anchor">#</a> 构造函数出错</h3> <p>另外一个需要完善的细节是，在构造函数中如果出错，将会自动触发 Promise 实例状态变为 rejected，因此我们用 try...catch 块对 executor 进行包裹，如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到目前为止，我们已经初步实现了基本的 Promise。得到一个好的实现结果固然重要，但是在实现过程中，我们也加深了对 Promise 的理解，得出下面一些重要结论。</p> <ul><li>Promise 的状态具有凝固性</li> <li>Promise 可以在 then 方法的第二个参数中进行错误处理</li> <li>Promise 实例可以添加多个 then 处理场景</li></ul> <p>距离完整的实现越来越近，接下来实现 Promise then 的链式调用效果。</p> <h2 id="promise-then的链式调用"><a href="#promise-then的链式调用" class="header-anchor">#</a> Promise-then的链式调用</h2> <p>在正式介绍此部分知识前，我们先来看一道题目：请判断一下代码的输出结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> next then</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt=""></p> <p>我们看到，Promise 实例的 then 方法支持链式调用，输出经过 resolve 处理后的值后，如果在 then 方法体的 onFulfilled 函数同步显示返回新的值，则将会在新 Promise 实例 then 方法的 onFulfilled 函数中输出新值。</p> <p>如果在第一个 then 方法体的 onFulfilled 函数中返回另一个 Promise 实例，结果又将如何呢？请看以下代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> next then</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上述代码将在 2s 后输出 Chualn ，紧接着再过 4s (第 6s )输出 Chulan next then。</p> <p>由此可知，一个 Promise 实例 then 方法的 onFulfilled 函数和 onRejected 函数支持返回一个非 Promise 实例的<code>普通值</code>，也是支持再次返回一个<code>Promise 实例</code>的；并且，返回的这个<code>普通值</code>或<code>Promise 实例</code>将会传给下一个 then 方法的 onFulfilled 函数或 onRejected 函数，这样 then 方法就可以支持链式调用了。</p> <h2 id="promise-链式调用初步实现"><a href="#promise-链式调用初步实现" class="header-anchor">#</a> Promise-链式调用初步实现</h2> <p>根据 <a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promise/A+ 规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>规定，then 方法必须返回一个新的 Promise 实例（后面会判断返回普通值的情况），即 promise2，最终代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> promise2
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个新的 promise2 resolved的值为 onFulfilled 的执行结果</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个新的 promise2 的经过 reject 处理后的值为 onRejected 的执行结果</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这里重点要了解 this.state === 'pending' 判断分支中的逻辑，这也是最难理解的。当使用 Promise 实例调用其 then 方法时，应该返回一个 Promise 实例，返回的就是this.state === 'pending' 判断分支中返回的 promise2。那么，这个 promise2 什么时候被决议呢？应该是在异步处理结束后，依次执行 onFulfilledArray 或 onRejectedArray 数组中的函数。</p> <p>我们在思考一下，onFulfilledArray 或 onRejectedArray 数组中的函数应该做些什么呢？很明显，需要切换 promise2 的状态，并进行决议。</p> <p>理顺了 onFulfilledArray 或 onRejectedArray 数组中的函数需要执行的逻辑，在进行改动。将 this.onFulfilledArray.push(onFulfilled) 的函数由。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
</code></pre></div><p>改为以下形式。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>this.onRejectedArray.push 函数的改动方式同理。</p> <p>这里的改动非常不容易，如果仍然想不明白，也不需要着急，还是应该先理解透 Promise 在返回来看，多看几次，一定会有所收货。</p> <p>请注意此时 Promise 实现的完整代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> promise2
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个新的 promise2 resolved的值为 onFulfilled 的执行结果</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个新的 promise2 的经过 reject 处理后的值为 onRejected 的执行结果</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promise-链式调用完整实现"><a href="#promise-链式调用完整实现" class="header-anchor">#</a> Promise-链式调用完整实现</h2> <p>先看两个例子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// onFulfilled返回 普通值</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> next then</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// onFulfilled返回 promise 实例</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> next then</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>根据以上两个例子结合上一栏实现的代码可知，let result = onFulfilled(this.value) 或 let result = onRejected(this.reason) 语句中，result 可能是一个普通值，也可能是一个 Promise 实例，为此我们可以抽象出 resolvePromise 方法(<a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promise/A+ 规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>规定) 进行统一处理，并用 x 变量替换 result。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @param {*} promise2 返回的 promise 实例
 * @param {*} x onFulfilled 或 onRejected 函数的返回值
 * @param {*} resolve promise2 的 resolve 方法
 * @param {*} reject promise2 的 reject 方法
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolvePromise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当 x 和 promise2 相等时，也就是在 onFulfilled 返回 promise2 时，执行 reject</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> promise2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'error due to circular reference'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 是否已经执行过 onFulfilled 或 onRejected</span>
  <span class="token keyword">let</span> consumed <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 初始未执行</span>
  <span class="token keyword">let</span> thenable

  <span class="token comment">// 如果 x 为 Promise ，则使 promise2 接受 x 的状态</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 x 处于等待态， promise 需保持为等待态直至 x 被执行或拒绝</span>
    <span class="token comment">// 注意&quot;直至 x 被执行或拒绝&quot;这句话，</span>
    <span class="token comment">// 这句话的意思是：x 被执行x，如果执行的时候拿到一个y，还要继续解析y</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> data<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> 
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> <span class="token function-variable function">isComplexX</span> <span class="token operator">=</span> <span class="token parameter">target</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>target <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

  <span class="token comment">// 如果返回的是疑似 Promise 类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isComplexX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      thenable <span class="token operator">=</span> x<span class="token punctuation">.</span>then
      <span class="token comment">// 判断返回值是否是 Promise 类型</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> thenable <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">thenable</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>consumed<span class="token punctuation">)</span> <span class="token keyword">return</span>
          consumed <span class="token operator">=</span> <span class="token boolean">true</span>

          <span class="token keyword">return</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> data<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>consumed<span class="token punctuation">)</span> <span class="token keyword">return</span>
          consumed <span class="token operator">=</span> <span class="token boolean">true</span>
          
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>consumed<span class="token punctuation">)</span> <span class="token keyword">return</span>
      consumed <span class="token operator">=</span> <span class="token boolean">true</span>

      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们看到，resolvePromise 方法的第一步就是对 “死循环” 进行处理，并再发生死循环是抛出错误。其中出现 “死循环” 的情况如下所示。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> p1 <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  
  <span class="token keyword">return</span> p1
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>接着，对于 onFulfilled 函数返回的结果 x；如果 x 不是 Promise 实例，不是对象，也不是函数，而是一个普通值的话( isComlexX 函数用于此进行判断)，则直接对 promise2 进行决议。</p> <p>对于 onFulfilled 函数返回的结果 x；如果 x 含有 then 属性方法，那么我们称该属性方法为 thenable，说明 x 是一个 Promise 实例，当执行该实例的 then 方法(即 thenable )是，返回结果可能还是一个 Promise 实例类型，也可能是一个普通值，因此还要递归调用 resolvePromise。如果不明白为什么要递归调用 resolvePromise，那么可以看一下下面的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> next then</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> next then</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以上代码将会在 2s 时输出 Chulan，在 10s 时输出 Chulan next then next then。</p> <p>此时，Promise 实现的完整代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> promise2
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个新的 promise2 resolved的值为 onFulfilled 的执行结果</span>
            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个新的 promise2 的经过 reject 处理后的值为 onRejected 的执行结果</span>
            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @param {*} promise2 返回的 promise 实例
 * @param {*} x onFulfilled 或 onRejected 函数的返回值
 * @param {*} resolve promise2 的 resolve 方法
 * @param {*} reject promise2 的 reject 方法
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolvePromise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当 x 和 promise2 相等时，也就是在 onFulfilled 返回 promise2 时，执行 reject</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> promise2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'error due to circular reference'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 是否已经执行过 onFulfilled 或 onRejected</span>
  <span class="token keyword">let</span> consumed <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 初始未执行</span>
  <span class="token keyword">let</span> thenable

  <span class="token comment">// 如果 x 为 Promise ，则使 promise2 接受 x 的状态</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 x 处于等待态， promise 需保持为等待态直至 x 被执行或拒绝</span>
    <span class="token comment">// 注意&quot;直至 x 被执行或拒绝&quot;这句话，</span>
    <span class="token comment">// 这句话的意思是：x 被执行x，如果执行的时候拿到一个y，还要继续解析y</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> data<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> 
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> <span class="token function-variable function">isComplexX</span> <span class="token operator">=</span> <span class="token parameter">target</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>target <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

  <span class="token comment">// 如果返回的是疑似 Promise 类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isComplexX</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      thenable <span class="token operator">=</span> x<span class="token punctuation">.</span>then
      <span class="token comment">// 判断返回值是否是 Promise 类型</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> thenable <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">thenable</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>consumed<span class="token punctuation">)</span> <span class="token keyword">return</span>
          consumed <span class="token operator">=</span> <span class="token boolean">true</span>

          <span class="token keyword">return</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> data<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>consumed<span class="token punctuation">)</span> <span class="token keyword">return</span>
          consumed <span class="token operator">=</span> <span class="token boolean">true</span>
          
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>consumed<span class="token punctuation">)</span> <span class="token keyword">return</span>
      consumed <span class="token operator">=</span> <span class="token boolean">true</span>

      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promise-静态方法和其他方法实现"><a href="#promise-静态方法和其他方法实现" class="header-anchor">#</a> Promise 静态方法和其他方法实现</h2> <p>接下来我们将实现以下方法。</p> <ul><li>Promise.protptype.catch</li> <li>Promise.resolve</li> <li>Promise.reject</li> <li>Promise.all</li> <li>Promise.race</li></ul> <h3 id="promise-protptype-catch-实现"><a href="#promise-protptype-catch-实现" class="header-anchor">#</a> Promise.protptype.catch 实现</h3> <p>Promise.protptype.catch 可以用来进行异常捕获，它的典型用法如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Chulan error'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以上代码会在 2s 后输出 Chulan error。</p> <p>其实在这种场景下，它与以下代码是等价的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">catchFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> catchFn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为我们知道 .then() 方法的第二个参数也就是进行异常捕获的，所以通过这个特性，我们可以比较简单地实现 Promise.protptype.catch。</p> <h3 id="promise-resolve-实现"><a href="#promise-resolve-实现" class="header-anchor">#</a> Promise.resolve 实现</h3> <p>MDN 上对于 Promise.resolve(value) 方法的介绍是这样的：Promise.resolve(value) 方法返回一个以给定值解析后的 Promise 实例对象。</p> <p>我们来看一个示例，如下。</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行以上代码将先输出 1，在输出 data。</p> <p>那么实现 Promise.resolve(value) 也很简单，具体代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="promise-reject-实现"><a href="#promise-reject-实现" class="header-anchor">#</a> Promise.reject 实现</h3> <p>根据 Promise.resolve(value) 实现原理，代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="promise-all-实现"><a href="#promise-all-实现" class="header-anchor">#</a> Promise.all 实现</h3> <p>MDN 上对于 Promise.all 的解释是：Promise.all(iterable) 方法返回一个 Promise 实例，此实例在 iterable 参数内的所有 Promise 实例都 <code>完成</code> ( resolved ) 或参数中不包括 Promise 实例时完成回调 ( resolved )；如果参数中 Promise 实例有一个失败 ( rejected ) ，则此实例回调失败 ( reject ) ，失败原因是第一个 Promise 实例失败的原因。</p> <p>先通过一个例子来体会一下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>执行以上代码会执行 <code>['Chulan1', 'Chulan2']</code></p> <p>这里的 Promise.all 的实现思路也很简单，如下。</p> <div class="language-js extra-class"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promiseArray</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArray<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'The arguments should be an array!'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> resultArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">const</span> length <span class="token operator">=</span> promiseArray<span class="token punctuation">.</span>length

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promiseArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          resultArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>resultArray<span class="token punctuation">.</span>length <span class="token operator">===</span> length<span class="token punctuation">)</span> <span class="token function">resolve</span><span class="token punctuation">(</span>resultArray<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个 Promise 实例，这个实例将会在 promiseArray 中的所有 Promise 实例被决议后进行决议，决议结果是一个数组，这个数组存有 promiseArray 重的所有 Promise 实例的决议值。</p> <p>此实现的整体思路是依赖一个 for 循环对 promiseArray 进行遍历。同样按照这个思路，我们还可以对 Promise.race 进行实现。</p> <h3 id="promise-race-实现"><a href="#promise-race-实现" class="header-anchor">#</a> Promise.race 实现</h3> <p>先来看一下 Promise.race 的用法，如下所示。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Chulan2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>执行以上代码，将会在 2s 后输出 Chulan1。实现 Promise.race 的代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promiseArray</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promiseArray<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'The arguments should be an array!'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> length <span class="token operator">=</span> promiseArray<span class="token punctuation">.</span>length

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        promiseArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们来简单分析一下，这里使用 for 循环同步执行 promiseArray 数组中所有 Promise 实例的 then 方法，第一个 resolve 的实例会直接触发新的 Promise 实例（ 代码中通过 new 新声明的 ）的 resolve 方法。</p> <h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <p>《前端开发核心知识进阶》</p> <p><a href="https://juejin.cn/post/6844903625769091079" target="_blank" rel="noopener noreferrer">BAT前端经典面试问题：史上最最最详细的手写Promise教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/7043758954496655397" target="_blank" rel="noopener noreferrer">手把手一行一行代码教你“手写Promise“，完美通过 Promises/A+ 官方872个测试用例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6994594642280857630" target="_blank" rel="noopener noreferrer">看了就会，手写Promise原理，最通俗易懂的版本！！！<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="sideTitle" data-v-07ed83de><div class="title" data-v-07ed83de>手写-Promise</div> <hr data-v-07ed83de> <ul data-v-07ed83de><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-初见雏形" data-v-07ed83de>Promise-初见雏形</a></li><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-异步实现完善" data-v-07ed83de>Promise-异步实现完善</a></li><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-细节完善" data-v-07ed83de>Promise-细节完善</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#多次调用then" data-v-07ed83de>多次调用then</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#onfulfilled-为-promise-的判断" data-v-07ed83de>onFulfilled 为 Promise 的判断</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-穿透" data-v-07ed83de>Promise 穿透</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#构造函数出错" data-v-07ed83de>构造函数出错</a></li><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-then的链式调用" data-v-07ed83de>Promise-then的链式调用</a></li><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-链式调用初步实现" data-v-07ed83de>Promise-链式调用初步实现</a></li><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-链式调用完整实现" data-v-07ed83de>Promise-链式调用完整实现</a></li><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-静态方法和其他方法实现" data-v-07ed83de>Promise 静态方法和其他方法实现</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-protptype-catch-实现" data-v-07ed83de>Promise.protptype.catch 实现</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-resolve-实现" data-v-07ed83de>Promise.resolve 实现</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-reject-实现" data-v-07ed83de>Promise.reject 实现</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-all-实现" data-v-07ed83de>Promise.all 实现</a></li><li class="level-3" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#promise-race-实现" data-v-07ed83de>Promise.race 实现</a></li><li class="level-2" data-v-07ed83de><a href="/vuepress-start/hand-wirte-code/promise/#参考文章" data-v-07ed83de>参考文章</a></li></ul></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-start/assets/js/app.8ee9e0f6.js" defer></script><script src="/vuepress-start/assets/js/2.cfb989c2.js" defer></script><script src="/vuepress-start/assets/js/4.f58268fa.js" defer></script><script src="/vuepress-start/assets/js/7.a1edbbdd.js" defer></script>
  </body>
</html>
